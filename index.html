<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #171717;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        .tab-bar {
            background-color: #1e1e1e;
            border-bottom: 1px solid #2d2d2d;
            display: flex;
            align-items: center;
            height: 35px;
            overflow-x: auto;
        }

        .tab {
            background-color: #252526;
            color: #cccccc;
            padding: 8px 16px;
            font-size: 13px;
            border-right: 1px solid #1e1e1e;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab.active {
            background-color: #2d2d2d;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #4CAF50;
        }

        .tab:hover {
            background-color: #2a2a2a;
        }

        .tab-close {
            font-size: 16px;
            line-height: 1;
            padding: 0 4px;
            margin-left: 4px;
            border-radius: 3px;
        }

        .tab-close:hover {
            background-color: #3a3a3a;
        }

        #container {
            width: 100%;
            height: calc(100vh - 35px);
        }
    </style>
</head>
<body>
    <div class="tab-bar" id="tabBar">
        <div class="tab active" data-tab-id="0">
            <span>Main Tab</span>
            <span class="tab-close" onclick="closeTab(0, event)">×</span>
        </div>
    </div>
    <div id="container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        let tabs = [];
        let activeTabId = 0;
        let tabCounter = 1;
        let editors = {};

        require.config({ 
            paths: { 
                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' 
            } 
        });

        require(['vs/editor/editor.main'], function () {
            // Define custom theme
            monaco.editor.defineTheme('CustomDark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'variable.language.self', foreground: '2f6331' },
                    { token: 'variable.parameter.variadic', foreground: '8fcb73' },
                    { token: 'variable.parameter.function', foreground: '8fcb73' },
                    { token: 'variable.other.constant', foreground: '79bf95' },
                    { token: 'variable.property', foreground: 'a7e0c6' },
                    { token: 'variable.object.property', foreground: 'caebdf' },

                    { token: 'keyword', foreground: '53807b' },
                    { token: 'keyword.local', foreground: '6c6387', fontStyle: 'bold' },
                    { token: 'keyword.operator', foreground: '75679d' },
                    { token: 'keyword.operator.type.annotation', foreground: '69627d' },
                    { token: 'keyword.operator.typedef.annotation', foreground: '51476e' },
                    { token: 'keyword.control.export', foreground: '433b5a', fontStyle: 'bold' },

                    { token: 'operator', foreground: '529875' },
                    { token: 'operator.type', foreground: '529875' },
                    { token: 'operator.special', foreground: '529875' },

                    { token: 'entity.name.type.alias', foreground: 'ffffff' },
                    { token: 'entity.name.function', foreground: '5fea62' },

                    { token: 'global', foreground: 'c6f3d4', fontStyle: 'bold' },

                    { token: 'storage.type', foreground: 'ffffff' },

                    { token: 'comment', foreground: '628580', fontStyle: 'bold' },
                    { token: 'comment.highlight.title', foreground: '628580', fontStyle: 'bold' },
                    { token: 'comment.highlight.name', foreground: '628580', fontStyle: 'bold' },
                    { token: 'comment.delimiter.modifier', foreground: '628580', fontStyle: 'bold' },
                    { token: 'comment.highlight.modifier', foreground: '628580', fontStyle: 'bold' },
                    { token: 'comment.highlight.descriptor', foreground: '628580', fontStyle: 'bold' },

                    { token: 'delimiter.longstring', foreground: 'b1ffb4' },
                    { token: 'delimiter.bracket', foreground: 'b1ffb4' },
                    { token: 'delimiter.array', foreground: 'b1ffb4' },
                    { token: 'delimiter.parenthesis', foreground: 'b1ffb4' },
                    { token: 'delimiter', foreground: 'b1ffb4' },

                    { token: 'string', foreground: '628580' },
                    { token: 'longstring', foreground: '628580' },
                    { token: 'string.delimeter', foreground: '628580' },
                    { token: 'string.escape', foreground: '628580' },

                    { token: 'punctuation.separator.arguments', foreground: 'ffffff' },
                    { token: 'punctuation.separator.parameter', foreground: 'ffffff' },
                    { token: 'punctuation.separator.table', foreground: 'ffffff' },
                    { token: 'punctuation.definition.block', foreground: 'ffffff' },
                    { token: 'punctuation.definition.parameters', foreground: 'ffffff' },
                    { token: 'punctuation.definition.typeparameters', foreground: 'ffffff' },

                    { token: 'constant.language', foreground: '72bf71' },
                    { token: 'number', foreground: '72bf71' },
                    { token: 'constants', foreground: '72bf71' },

                    { token: 'support.function', foreground: 'a1fca3' },
                    { token: 'support.function.library', foreground: 'a1fca3' },
                    { token: 'support.type', foreground: 'a1fca3' },
                ],
                colors: {
                    'editor.background': '#171717',
                    'editor.lineHighlightBackground': '#1e1e1e',
                    'editorLineNumber.foreground': '#858585',
                    'editorLineNumber.activeForeground': '#4CAF50',
                    'minimap.background': '#1C1A21',
                    'scrollbarSlider.background': '#424242',
                    'scrollbarSlider.hoverBackground': '#4f4f4f',
                    'scrollbarSlider.activeBackground': '#5a5a5a'
                }
            });

            // Initialize first tab
            tabs.push({
                id: 0,
                name: 'Main Tab',
                content: ''
            });

            // Create initial editor
            createEditor(0, '');

            window.addEventListener('resize', () => {
                if (editors[activeTabId]) {
                    editors[activeTabId].layout();
                }
            });
        });

        function createEditor(tabId, content) {
            const editor = monaco.editor.create(document.getElementById('container'), {
                value: content || '',
                language: 'lua',
                theme: 'CustomDark',
                folding: false,
                dragAndDrop: false,
                links: false,
                minimap: {
                    enabled: false,
                },
                showFoldingControls: 'always',
                smoothScrolling: true,
                stopRenderingLineAfter: 6500,
                fontSize: 14,
                cursorBlinking: 'smooth',
                cursorSmoothCaretAnimation: true,
                foldingHighlight: false,
                fontLigatures: true,
                formatOnPaste: true,
                showDeprecated: true,
                suggest: {
                    snippetsPreventQuickSuggestions: false,
                },
                lineNumbers: 'on',
                glyphMargin: false,
                scrollBeyondLastLine: false,
                automaticLayout: true
            });

            editor.getModel().updateOptions({ insertSpaces: false });
            editors[tabId] = editor;
            return editor;
        }

        // Functions to be called from WinForms
        function AddTab(tabName) {
            const tabId = tabCounter++;
            tabs.push({
                id: tabId,
                name: tabName || `Tab ${tabId}`,
                content: ''
            });

            const tabBar = document.getElementById('tabBar');
            const tabElement = document.createElement('div');
            tabElement.className = 'tab';
            tabElement.setAttribute('data-tab-id', tabId);
            tabElement.innerHTML = `
                <span>${tabName || `Tab ${tabId}`}</span>
                <span class="tab-close" onclick="closeTab(${tabId}, event)">×</span>
            `;
            tabElement.onclick = function(e) {
                if (!e.target.classList.contains('tab-close')) {
                    switchTab(tabId);
                }
            };
            tabBar.appendChild(tabElement);

            switchTab(tabId);
            return tabId;
        }

        function closeTab(tabId, event) {
            if (event) {
                event.stopPropagation();
            }

            // Don't close if it's the last tab
            if (tabs.length === 1) {
                return;
            }

            const tabIndex = tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;

            // Remove tab from array
            tabs.splice(tabIndex, 1);

            // Remove tab element
            const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
            if (tabElement) {
                tabElement.remove();
            }

            // Dispose editor
            if (editors[tabId]) {
                editors[tabId].dispose();
                delete editors[tabId];
            }

            // Switch to another tab if the closed tab was active
            if (activeTabId === tabId) {
                const newActiveTab = tabs[Math.max(0, tabIndex - 1)];
                switchTab(newActiveTab.id);
            }
        }

        function CloseTab(tabId) {
            closeTab(tabId);
        }

        function switchTab(tabId) {
            // Save current tab content
            if (editors[activeTabId]) {
                const currentTab = tabs.find(t => t.id === activeTabId);
                if (currentTab) {
                    currentTab.content = editors[activeTabId].getValue();
                }
                // Hide current editor
                editors[activeTabId].getDomNode().style.display = 'none';
            }

            // Update active tab
            activeTabId = tabId;

            // Update tab styles
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
            if (activeTabElement) {
                activeTabElement.classList.add('active');
            }

            // Show or create editor for new tab
            if (!editors[tabId]) {
                const tab = tabs.find(t => t.id === tabId);
                createEditor(tabId, tab ? tab.content : '');
            } else {
                editors[tabId].getDomNode().style.display = 'block';
                editors[tabId].layout();
            }
        }

        function SwitchTab(tabId) {
            switchTab(tabId);
        }

        function GetText(tabId) {
            const targetTabId = tabId !== undefined ? tabId : activeTabId;
            if (editors[targetTabId]) {
                return editors[targetTabId].getValue();
            }
            const tab = tabs.find(t => t.id === targetTabId);
            return tab ? tab.content : '';
        }

        function SetText(text, tabId) {
            const targetTabId = tabId !== undefined ? tabId : activeTabId;
            if (editors[targetTabId]) {
                editors[targetTabId].setValue(text);
            } else {
                const tab = tabs.find(t => t.id === targetTabId);
                if (tab) {
                    tab.content = text;
                }
            }
        }

        function GetActiveTabId() {
            return activeTabId;
        }

        function GetAllTabs() {
            return tabs.map(t => ({ id: t.id, name: t.name }));
        }

        function RenameTab(tabId, newName) {
            const tab = tabs.find(t => t.id === tabId);
            if (tab) {
                tab.name = newName;
                const tabElement = document.querySelector(`[data-tab-id="${tabId}"] span:first-child`);
                if (tabElement) {
                    tabElement.textContent = newName;
                }
            }
        }
    </script>
</body>
</html>
